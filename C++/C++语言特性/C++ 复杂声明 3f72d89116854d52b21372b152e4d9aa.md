# C++ 复杂声明

平常我们在代码中看见类似 void * (*(*fp1)(int))[10]; 的复杂声明，总是让人心烦意乱。今天我们就来破除这个紧箍咒。

### 函数声明

在解之前，先看一个入门的知识点，指针函数作为参数传递。

```cpp
int func_call(string text) {
	cout << text << endl;
	return 5;
}
void func_pointer(int (*fp)(string)) {
	cout << fp("func_pointer") << endl;
}
void main() {
	int (*fp)(string);//声明函数指针，此函数接受一个字符串参数并返回一个整型
	fp = func_call;
	func_pointer(fp);//将函数指针作为参数传递
}
```

### 从实践入手

怎么声明函数指针相信大家都很清楚，现在就来解复杂声明

- **`void * (*(*fp1)(int))[10];`**

解 1：

（1）包含 fp1 的最内层小括号是 (*fp1)：fp1 是指针

（2）往 (*fp1) 右边看是(int), 右边是小括号即是函数：指向带有一个 int 型参数的函数

（3）再往 (*fp1) 左边看是 *，当右边是函数，左边即是函数的返回值：且函数返回一个指针

（4）往 (*(*fp1)(int)) 右边看是[10]，右边中括号表示数组：指针指向一个大小为 10 的数组

（5）再往 (*(*fp1)(int)) 左边看是 void *，即是数组的类型：数组类型为 void *

好了，把整段话拼出来吧：fp1 是指针，指向带有一个 int 型参数的函数，且函数返回一个指针，指针指向一个大小为 10 的数组，数组类型为 void *

- `float (*(*fp2)(int,int,float))(int);`

解 2：

（1）包含 fp2 的最内层小括号是 (*fp2)：fp2 是指针

（2）往 (*fp2) 右边看是(int,int,float), 右边是小括号即是函数：指向带有 3 个参数的函数

（3）再往 (*fp2) 左边看是 *，当右边是函数，左边即是函数的返回值：且函数返回一个指针

（4）往 (*(*fp2)(int,int,float)) 右边看是(int)，右边小括号表示函数：指针指向带 1 个整型参数的函数（5）再往 (*(*fp2)(int,int,float)) 左边看是 float，即是函数的返回值：函数返回 float

把整段话拼出来：fp2 是指针，指向带有 3 个参数的函数，且函数返回一个指针，指针指向带 1 个整型参数的函数，函数返回 float

### “右左法则”

理解复杂声明可用的 “右左法则”：

从变量名看起，先往右，再往左，**碰到一个圆括号就调转阅读的方向；括号内分析完就跳出括号，还是按先右后左的顺序，如此循环，直到整个声明分析完。举例：**

`int (*func)(int *p);`

首 先找到变量名 func，外面有一对圆括号，而且左边是一个 * 号，这说明 func 是一个指针；然后跳出这个圆括号，先看右边，又遇到圆括号，这说明 (*func) 是一个函数，所以 func 是一个指向这类函数的指针，即函数指针，这类函数具有 int * 类型的形参，返回值类型是 int。

`int (*func[5])(int *);`

func 右边是一个 [] 运算符，说明 func 是具有 5 个元素的数组；func 的左边有一个 *，说明 func 的元素是指针（注意这里的 * 不是修饰 func，而是修饰 func[5]的，原因是 [] 运算符优先级比 * 高，func 先跟 [] 结合）。跳出这个括号，看右边，又遇到圆括号，说明 func 数组的元素是函数类型的指 针，它指向的函数具有 int * 类型的形参，返回值类型为 int。

### 如果加上typedef呢？

**typedef能够为复杂的声明定义一个新的简单的别名**。方法是：在原来的声明里逐步用别名替换一部分复杂声明，如此循环，把带变量名的部分留到最后替换，得到的就是原声明的最简化版。举例：

- 原声明：int *(*a[5])(int, char*)

变量名为 a，直接用一个新别名 pFun 替换 a 就可以了：typedef int *(*pFun)(int, char*); 原声明的最简化版：pFun a[5];

- 原声明：void (*b[10]) (void (*)());

变量名为 b，先替换右边部分括号里的，

pFunParam 为别名一：typedef void (*pFunParam)();

再替换左边的变量 b，

pFunx 为别名二：typedef void (*pFunx)(pFunParam);

原声明的最简化版：pFunx b[10];

- 原声明：doube(*)() (*e)[9];

变量名为 e，先替换左边部分，

pFuny 为别名一：typedef double(*pFuny)();

再替换右边的变量 e，

pFunParamy 为别名二typedef pFuny (*pFunParamy)[9];

原声明的最简化版：pFunParamy e;

### 我对typdef的理解

typedef相当于一个占位符，或是说是一种替代的规则，并不是一种定义式或其他，只是为了简化冗长的定义式。typedef将定义一个未明确的声明式，再在真正定义时由编辑器填入内容。

```cpp
例1：
typdef size_t siz; （1）
siz a;  （2）
=> 上面这个定义式（2）相当于将 a 填入（1）中siz的位置
=> 就变成了 size_t a;

例子2：
typdef struct A{
	int x;
	int y;
}Point;
Point y;
=> 相当于用y替代Point的位置

例子3：
int *(*pFunc)(int, char*);
pFunc f[10];
=> 相当于使用f[10]代替pFunc的位置
=>  int *(*f[10])(int, char*);
=> 这是一个完整的定义式
```