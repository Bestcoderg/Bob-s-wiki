# 编译优化 UnityBuild

首先我们需要谈谈 UnityBuid 是什么？可以先下个定义， UnityBuild 与 pch 类似，都是一种编译优化的方式。所以说在聊 UnityBuild 之前我们需要先聊聊编译优化的问题。C++ 作为一种典型的AOT类型的语言，编译优化永远是绕不开的话题。个人作为后端程序员，每当看着前端程序员使用 C# 这类 JIT 语言甚至是 Lua 这一类解释型语言时，对其在开发过程中一些及该即用的操作，而自己在苦逼等待编译与链接。心中还是不免羡慕的。所以，为了减少我们苦逼等待的时间，我们需要尽量对我们的编译时间做出优化。

在优化我们的编译时间之前，我们需要了解编译过程中，什么操作耗时量最大？不知道是否各位与我之前一样，认为编译过程中的主要耗时在后端编译将中间代码编译为机器码的过程上。但实际上可以参考 [2] 这篇文章。**利用文章中的一些数据我们会惊讶的发现，实际上前端编译器 source 的过程在我们这类引用复杂的项目中占用了大部分时间。**

在 source 过程中，一个编译单元需要索引并预处理所有引用的头文件。当项目编译单元膨胀且头文件引用的较多时，这将消耗我们大量的时间。一般对此的优化技巧可以参考 [3] 文章。在编译阶段一般使用以下三种方式

- Pch
- UntiyBuild
- ccache

一般来说pch的方式比较常见，我们项目也在上次的编译优化过程中引入了pch(cotire)。其原理也是将一些头文件放在预编译头文件中，这样就减少了编译过程中 source 头文件的次数。而 UnityBuild 的方式则是通过合并 .cpp 的方式，即直接减少编译单元来优化编译速度。同时，在合并 .cpp 后，实际上之间单个编译单元在编译过程中需要 source 大量头文件的问题同时被解决了。

## 如何引入UnityBuild

UnityBuild实际上就是将一些编译单元合并了，参考 [4] 文章中，我们可以手动合并这些 .cpp 文件。当然，更好的办法还是直接使用 cmake 在 3.16 后引入的cmake UnityBuild，cmake将自动按其规则帮我们合并编译单元。可以参考cmake文档 [4] 。

## 引入UnityBuild带来了什么？

在我们的项目中引入UntiyBuild后，我做了一些测试，在使用64核编译的情况下，**测试结果如下**(测试结果都不包含rogamelibs编译)：

|  | UnityBuild | Normal |
| --- | --- | --- |

可以看到，UnityBuild为我们的编译速度带来了极大的提升。尤其在编译单元数量大的时候，这种提升尤为明显。同时，由于我们编译单元数量的下降，我们对于编译cpu核数的依赖也会下降很多，当使用的编译核数下降时，这两种编译方式的差距会更加明显。

## Unity Build 的缺陷

由于UnityBuild 合并了大量的编译单元，实际上也带来了一些问题。

- **头文件内的重定义**
由于C++分离式编译的特性，我们实际上可以在不同的头文件中定义同名的方法或是类，只要这两个编译单元不会最终同时引用到这两个头文件。但由于我们现在合并了编译单元，这一种写法现在将会导致头文件内的重定义。对于这一点，我实际上认为在头文件中定义相同的方法或是类本身就是不合理的，因为只要某天某个编译单元同时用到了这两个头文件，这个问题就会出现，UnityBuild 只是加速了问题的爆发。(就我们项目来说 share库 与 )
- **内部函数冲突**
第二个问题时内部函数冲突的问题，实际上在c++中我们是提倡写内部函数的。但UnityBuild由于合并了编译单元，如果你在两个编译单元中定义了同名的内部函数，将会导致内部函数的冲突。当然实际上我在项目引入UnityBuild的过程中发现，一般同名的内部函数的实现也是相同的。对于这一类内部函数的使用就不是很提倡了，如果一个内部函数需要定义多次最好还是声明在统一的头文件后再进行定义。**对于那些内部函数切有着不同实现的，现在需要采用不同的命名。**
- **带来的编译速度问题**
实际上在引入UnityBuild之前，我对于单个编译单元更改一部分代码这种情况，我是比较担心其速度问题的，因为在合并编译单元后，理论上来说各个编译单元之间的引用关系会更多。在改动到一个编译单元后可能会编译很多编译单元。所以纯就中间代码编译的量来说，这种情况下UnityBuild的量应是大于原来的方式。但实际情况下我发现，实际上这部分增加的消耗相对整个编译时间来说相当小。同时用于 .o 文件数量的减少，link速度也有小幅度的提升。所以这个问题目前看来没有什么严重影响。

想不到其他的比较严重的问题了，有问题及时@葛华盛

## 参考文章

[1] https://cmake.org/cmake/help/latest/prop_tgt/UNITY_BUILD.html

[2] https://zhuanlan.zhihu.com/p/466738535

[3] https://zhuanlan.zhihu.com/p/29346995

[4] https://blog.csdn.net/weixin_39955418/article/details/110597155